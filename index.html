<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPS Journey Recorder - Mobile Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <style>
    :root {
      --main-bg: #f4f7fb;
      --surface: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #2176ae;
      --accent-contrast: #ffffff;
      --accent-dark: #195c83;
      --danger: #e53935;
      --ok: #2e7d32;
      --warning: #f59e0b;
      --radius: 12px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --pad: 12px;
      --gap: 10px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
      --shadow-md: 0 4px 16px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --main-bg: #0b1220;
        --surface: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #5cc1ff;
        --accent-contrast: #06121d;
        --accent-dark: #2ea4dd;
        --danger: #ff6b6b;
        --ok: #52d273;
        --warning: #f6c453;
        --shadow-sm: 0 1px 2px rgba(0,0,0,.5);
        --shadow-md: 0 6px 24px rgba(0,0,0,.45);
      }
    }
    html, body {
      height: 100svh;
      min-height: 100vh;
      background: var(--main-bg);
      color: var(--text);
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: flex;
      flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      -webkit-tap-highlight-color: transparent;
      scroll-behavior: smooth;
    }

    #controls {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--surface);
      border-bottom: 1px solid rgba(2, 6, 23, .08);
      box-shadow: var(--shadow-sm);
      padding: 8px max(10px, env(safe-area-inset-left)) 10px max(10px, env(safe-area-inset-right));
    }
    .controls-wrap {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--gap);
      align-items: center;
    }
    @media (max-width: 840px) {
      .controls-wrap { grid-template-columns: 1fr; }
    }
    .control-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--gap);
      min-height: 44px;
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: var(--radius-xs);
      padding: 10px 14px;
      font-size: 15px;
      line-height: 1;
      min-height: 44px;
      min-width: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      transition: transform .05s ease, background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: var(--accent-contrast); }
    .btn-primary:active { background: var(--accent-dark); }
    .btn-outline {
      background: transparent; color: var(--accent);
      border: 2px solid var(--accent);
    }
    .btn-ghost {
      background: transparent; color: var(--text);
      border: 1px solid rgba(2, 6, 23, .08);
    }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-chip {
      background: #eaf4fb;
      color: var(--accent-dark);
      border-radius: 999px;
      padding: 8px 12px;
    }
    @media (prefers-color-scheme: dark) {
      .btn-chip { background: #0b2030; }
    }
    .btn-icon {
      padding: 10px;
      width: 44px;
      min-width: 44px;
      justify-content: center;
    }

    .btn-group {
      display: inline-flex;
      border-radius: var(--radius-xs);
      overflow: clip;
      border: 1px solid rgba(2,6,23,.08);
      background: var(--surface);
    }
    .btn-group .btn {
      border-radius: 0;
      min-width: 64px;
      border-right: 1px solid rgba(2,6,23,.08);
      box-shadow: none;
    }
    .btn-group .btn:last-child { border-right: 0; }
    @media (max-width: 620px) {
      .btn-group { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .btn-group .btn { min-width: 56px; }
    }

    .field {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #eef6fb;
      color: var(--text);
      padding: 6px 8px 6px 10px;
      border-radius: var(--radius-xs);
      border: 1px solid rgba(2,6,23,.08);
    }
    @media (prefers-color-scheme: dark) {
      .field { background: #0b2030; }
    }
    .field label { font-size: 14px; color: var(--muted); }
    .field input[type=number] {
      width: 70px;
      font-size: 15px;
      padding: 6px 8px;
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      outline: none;
    }

    .dropdown { position: relative; display: inline-block; }
    .menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--surface);
      border: 1px solid rgba(2,6,23,.08);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius);
      padding: 6px;
      display: none;
      min-width: 240px;
      z-index: 1100;
    }
    .menu.open { display: block; }
    .menu .group-title {
      font-size: 12px;
      letter-spacing: .04em;
      color: var(--muted);
      padding: 6px 10px 4px 10px;
      text-transform: uppercase;
    }
    .menu .item {
      width: 100%;
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      min-height: 40px;
      min-width: auto;
      box-shadow: none;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .menu .item:hover { background: rgba(2,6,23,.05); }
    @media (prefers-color-scheme: dark) {
      .menu .item:hover { background: rgba(255,255,255,.06); }
    }
    @media (max-width: 540px) {
      .menu {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        top: auto;
        border-radius: 16px 16px 0 0;
        padding-bottom: calc(6px + env(safe-area-inset-bottom));
        margin: 0 auto;
        max-width: 640px;
      }
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    #stats, #status {
      font-size: 14px;
      padding: 8px 12px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 999px;
    }
    #status.ok { color: var(--ok); border-color: rgba(46,125,50,.25); }
    #status.warn { color: var(--warning); border-color: rgba(245,158,11,.25); }
    #status.err { color: var(--danger); border-color: rgba(229,57,53,.25); }

    #chart-container {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 8px 8px 0 8px;
      margin: 10px max(10px, env(safe-area-inset-right)) 8px max(10px, env(safe-area-inset-left));
      box-shadow: var(--shadow-sm);
      flex: 0 0 auto;
    }
    #chart { width: 100%; height: 120px; display: block; }

    #map {
      margin: 8px max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      background: #d0d7e2;
      flex: 1 1 auto;
      min-height: 260px;
      overflow: clip;
    }

    @media (max-width: 740px) {
      .field input[type=number] { width: 64px; }
      #chart { height: 100px; }
    }
    @media (max-width: 480px) {
      .btn { min-height: 40px; font-size: 14px; padding: 9px 12px; }
      .btn-icon { width: 40px; min-width: 40px; padding: 8px; }
      #chart { height: 84px; }
      #map { min-height: 220px; }
    }
  </style>
</head>
<body>
  <div id="controls">
    <div class="controls-wrap">
      <div class="control-row" aria-label="Recording controls">
        <div class="btn-group" role="group" aria-label="Record">
          <button id="startBtn" class="btn btn-ghost" title="Start recording">‚ñ∂Ô∏è Start</button>
          <button id="pauseBtn" class="btn btn-ghost" disabled title="Pause recording">‚è∏Ô∏è Pause</button>
          <button id="resumeBtn" class="btn btn-ghost" disabled title="Resume recording">‚ñ∂Ô∏è Resume</button>
          <button id="stopBtn" class="btn btn-ghost" disabled title="Stop and draw path">‚èπÔ∏è Stop</button>
        </div>

        <div class="field" aria-label="Minimum accuracy">
          <label id="accuracyLabel" for="accuracyInput">Min Acc</label>
          <input type="number" id="accuracyInput" value="15" min="5" max="50" step="1" aria-labelledby="accuracyLabel">
          <span class="unit" aria-hidden="true">m</span>
        </div>

        <button id="toggleGraph" class="btn btn-outline btn-icon" title="Show/hide accuracy graph" aria-pressed="true">üìä</button>

        <div class="dropdown">
          <button id="downloadBtn" class="btn btn-primary" disabled title="Download" aria-haspopup="menu" aria-expanded="false">‚¨áÔ∏è Download</button>
          <div id="downloadMenu" class="menu" role="menu" aria-hidden="true">
            <div class="group-title">Structured</div>
            <button id="downloadJson" class="item" role="menuitem">üßæ JSON (with metadata)</button>
            <button id="downloadGeoJson" class="item" role="menuitem">üó∫Ô∏è GeoJSON</button>
            <div class="group-title">GIS</div>
            <button id="downloadKml" class="item" role="menuitem">üåç KML (Google Earth)</button>
            <button id="downloadKmlPath" class="item" role="menuitem">üßµ KML (Path only, no pins)</button>
            <button id="downloadGpx" class="item" role="menuitem">üìç GPX (GPS Exchange)</button>
            <div class="group-title">Tables & Text</div>
            <button id="downloadCsv" class="item" role="menuitem">üìä CSV</button>
            <button id="downloadTsv" class="item" role="menuitem">üìã TSV</button>
            <button id="downloadTxt" class="item" role="menuitem">üìù Plain Text (lat,lng)</button>
          </div>
        </div>

        <button id="resetBtn" class="btn btn-danger" disabled title="Reset journey">‚ôªÔ∏è Reset</button>
      </div>

      <div class="control-row" aria-live="polite">
        <div class="chips">
          <div id="stats" class="btn-chip"></div>
          <div id="status" class="btn-chip"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    function formatTime(ms) {
      let s = Math.floor(ms / 1000);
      let h = Math.floor(s / 3600);
      let m = Math.floor((s % 3600) / 60);
      s = s % 60;
      return `${h>0?h+':':''}${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
    }
    function formatDate(ts) {
      if (ts === undefined || ts === null || Number.isNaN(ts)) return '';
      const d = new Date(ts);
      return isNaN(d.getTime()) ? '' : d.toLocaleTimeString();
    }
    function isoTime(ts) {
      if (ts === undefined || ts === null || Number.isNaN(ts)) return '';
      const d = new Date(ts);
      return isNaN(d.getTime()) ? '' : d.toISOString();
    }
    function saveToStorage() {
      localStorage.setItem('journey_gps', JSON.stringify({
        journey, started, paused, startTime, minAccuracy, accuracyList
      }));
    }
    function loadFromStorage() {
      const d = localStorage.getItem('journey_gps');
      if (!d) return null;
      try { return JSON.parse(d); } catch { return null; }
    }
    function clearStorage() { localStorage.removeItem('journey_gps'); }

    let map, path;
    let watchId = null;
    let journey = [];
    let markerCluster = null;
    let started = false;
    let paused = false;
    let startTime = null;
    let timerInterval = null;
    let minAccuracy = 15;
    let accuracyList = [];
    let chart = null;
    let graphVisible = true;

    function setupChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{
          label: 'Accuracy (m)',
          data: [],
          borderColor: '#2176ae',
          backgroundColor: 'rgba(33,118,174,0.12)',
          tension: 0.25,
          pointRadius: 0,
          borderWidth: 2
        }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { display: false }, y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }
    function updateChart(acc) {
      if (!chart) return;
      chart.data.labels.push('');
      chart.data.datasets[0].data.push(acc);
      if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update('none');
    }

    function initMap(lat = 51.505, lng = -0.09, zoom = 13) {
      map = L.map('map', { zoomControl: true }).setView([lat, lng], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      setTimeout(() => map.invalidateSize(), 200);
      window.addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 200));
      window.addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 400));
    }
    function createClusterGroup() {
      if (markerCluster) { markerCluster.clearLayers(); map.removeLayer(markerCluster); }
      markerCluster = L.markerClusterGroup();
      map.addLayer(markerCluster);
    }
    function pinColor(accuracy) {
      if (accuracy < 8) return 'green';
      if (accuracy < 15) return 'yellow';
      if (accuracy < 25) return 'orange';
      return 'red';
    }
    function addPinToCluster(lat, lng, infoHTML, accuracy) {
      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: pinColor(accuracy),
        fillColor: pinColor(accuracy),
        fillOpacity: .85,
        weight: 2
      });
      marker.bindPopup(infoHTML);
      markerCluster.addLayer(marker);
    }
    function clearPins() {
      if (markerCluster) { markerCluster.clearLayers(); map.removeLayer(markerCluster); markerCluster = null; }
    }
    function drawPath(points, animate=false) {
      if (path) map.removeLayer(path);
      path = L.polyline([], { color: '#2176ae', weight: 5 }).addTo(map);
      if (animate && points.length > 1) {
        let i = 0;
        (function addNext() {
          if (i < points.length) { path.addLatLng(points[i]); i++; setTimeout(addNext, 25); }
          else { try { map.fitBounds(path.getBounds(), { padding: [20, 20] }); } catch {} }
        })();
      } else {
        path.setLatLngs(points);
        if (points.length) try { map.fitBounds(path.getBounds(), { padding: [20, 20] }); } catch {}
      }
    }
    function updateLivePath() {
      const points = journey.map(j => [j.latitude, j.longitude]);
      if (path) map.removeLayer(path);
      path = L.polyline(points, { color: '#2176ae', weight: 5 }).addTo(map);
      if (points.length) map.panTo(points[points.length-1], { animate: true });
    }

    function updateStatsDisplay() {
      if (!journey.length) { document.getElementById('stats').textContent = ''; return; }
      let dist = 0;
      for (let i=1; i<journey.length; i++) {
        dist += haversine(journey[i-1].latitude, journey[i-1].longitude, journey[i].latitude, journey[i].longitude);
      }
      dist = Math.round(dist);
      let elapsed = startTime ? Date.now() - startTime : 0;
      let speed = journey.length > 1 && journey[journey.length-1].speed !== null
        ? (journey[journey.length-1].speed*3.6).toFixed(1) + ' km/h' : '-';
      let avgAcc = (journey.reduce((a,j)=>a+j.accuracy,0)/journey.length).toFixed(1);
      document.getElementById('stats').innerHTML =
        `üìè ${dist} m ¬∑ ‚è±Ô∏è ${formatTime(elapsed)} ¬∑ üöÄ ${speed} ¬∑ üéØ ${avgAcc} m`;
    }
    function updateStatusDisplay(text, type='') {
      const el = document.getElementById('status');
      el.classList.remove('ok','warn','err');
      if (type) el.classList.add(type);
      el.textContent = text;
    }

    const downloadBtnEl = () => document.getElementById('downloadBtn');
    const downloadMenuEl = () => document.getElementById('downloadMenu');
    function setDownloadEnabled(enabled) {
      const btn = downloadBtnEl();
      btn.disabled = !enabled;
      btn.setAttribute('aria-expanded', enabled ? 'false' : 'false');
      if (!enabled) closeDownloadMenu();
    }
    function toggleDownloadMenu() {
      const btn = downloadBtnEl();
      if (btn.disabled) return;
      const menu = downloadMenuEl();
      const isOpen = menu.classList.contains('open');
      menu.classList.toggle('open', !isOpen);
      menu.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
      btn.setAttribute('aria-expanded', (!isOpen).toString());
    }
    function closeDownloadMenu() {
      const btn = downloadBtnEl();
      const menu = downloadMenuEl();
      menu.classList.remove('open');
      menu.setAttribute('aria-hidden', 'true');
      btn.setAttribute('aria-expanded', 'false');
    }
    document.addEventListener('click', (e) => {
      const dd = downloadBtnEl().parentElement;
      if (!dd.contains(e.target)) closeDownloadMenu();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDownloadMenu();
    });

    function downloadBlob(content, mime, filename) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadJourneyJSON() {
      const exportData = { journey, started, paused, startTime, minAccuracy, accuracyList };
      downloadBlob(JSON.stringify(exportData, null, 2), "application/json", "journey.json");
      updateStatusDisplay("JSON downloaded!", "ok");
    }

    function journeyToKml(journey) {
      if (!journey?.length) return '';
      const pathColor = 'ffae7621';
      const coordsLine = journey.map(j => `${j.longitude.toFixed(6)},${j.latitude.toFixed(6)},0`).join('\n');
      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
      kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n  <Document>\n    <name>GPS Journey</name>\n`;
      kml += `    <Style id="pathStyle"><LineStyle><color>${pathColor}</color><width>4</width></LineStyle></Style>\n`;
      kml += `    <Placemark>\n      <name>Path</name>\n      <styleUrl>#pathStyle</styleUrl>\n      <LineString>\n        <tessellate>1</tessellate>\n        <coordinates>\n${coordsLine}\n        </coordinates>\n      </LineString>\n    </Placemark>\n`;
      kml += `    <Folder>\n      <name>Points</name>\n`;
      journey.forEach((j, idx) => {
        const desc = [
          `Lat: ${j.latitude.toFixed(6)}`,
          `Lng: ${j.longitude.toFixed(6)}`,
          `Accuracy: ${j.accuracy} m`,
          `Speed: ${j.speed !== undefined && j.speed !== null ? (j.speed*3.6).toFixed(1)+' km/h' : 'N/A'}`,
          `Heading: ${j.heading !== undefined && j.heading !== null ? j.heading.toFixed(1) + '¬∞' : 'N/A'}`
        ].join(' | ');
        const when = isoTime(j.timestamp);
        kml += `      <Placemark>\n        <name>Point ${idx+1}</name>\n`;
        if (when) kml += `        <TimeStamp><when>${when}</when></TimeStamp>\n`;
        kml += `        <description><![CDATA[${desc}]]></description>\n        <Point><coordinates>${j.longitude.toFixed(6)},${j.latitude.toFixed(6)},0</coordinates></Point>\n      </Placemark>\n`;
      });
      kml += `    </Folder>\n`;
      const first = journey[0], last = journey[journey.length - 1];
      const firstWhen = isoTime(first.timestamp), lastWhen = isoTime(last.timestamp);
      kml += `    <Placemark><name>Start</name>${firstWhen?`<TimeStamp><when>${firstWhen}</when></TimeStamp>`:''}<Point><coordinates>${first.longitude.toFixed(6)},${first.latitude.toFixed(6)},0</coordinates></Point></Placemark>\n`;
      kml += `    <Placemark><name>End</name>${lastWhen?`<TimeStamp><when>${lastWhen}</when></TimeStamp>`:''}<Point><coordinates>${last.longitude.toFixed(6)},${last.latitude.toFixed(6)},0</coordinates></Point></Placemark>\n`;
      kml += `  </Document>\n</kml>\n`;
      return kml;
    }
    function downloadJourneyKML() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const kml = journeyToKml(journey);
      downloadBlob(kml, "application/vnd.google-earth.kml+xml", "journey.kml");
      updateStatusDisplay("KML downloaded!", "ok");
    }

    // NEW: KML path-only (no pins)
    function journeyToKmlPathOnly(journey) {
      if (!journey?.length) return '';
      const pathColor = 'ffae7621';
      const coordsLine = journey.map(j => `${j.longitude.toFixed(6)},${j.latitude.toFixed(6)},0`).join('\n');
      return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>GPS Journey (Path Only)</name>
    <Style id="pathStyle"><LineStyle><color>${pathColor}</color><width>4</width></LineStyle></Style>
    <Placemark>
      <name>Path</name>
      <styleUrl>#pathStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>
${coordsLine}
        </coordinates>
      </LineString>
    </Placemark>
  </Document>
</kml>
`;
    }
    function downloadJourneyKMLPathOnly() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const kml = journeyToKmlPathOnly(journey);
      downloadBlob(kml, "application/vnd.google-earth.kml+xml", "journey_path_only.kml");
      updateStatusDisplay("KML (path only) downloaded!", "ok");
    }

    function journeyToGpx(journey) {
      if (!journey?.length) return '';
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="GPS Journey Recorder" xmlns="http://www.topografix.com/GPX/1/1">\n  <trk>\n    <name>GPS Journey</name>\n    <trkseg>\n`;
      journey.forEach(j => {
        const time = isoTime(j.timestamp);
        gpx += `      <trkpt lat="${j.latitude}" lon="${j.longitude}">\n`;
        if (j.accuracy !== undefined && j.accuracy !== null) gpx += `        <hdop>${j.accuracy}</hdop>\n`;
        if (j.speed !== undefined && j.speed !== null) gpx += `        <speed>${j.speed}</speed>\n`;
        if (j.heading !== undefined && j.heading !== null) gpx += `        <course>${j.heading}</course>\n`;
        if (time) gpx += `        <time>${time}</time>\n`;
        gpx += `      </trkpt>\n`;
      });
      gpx += `    </trkseg>\n  </trk>\n</gpx>\n`;
      return gpx;
    }
    function downloadJourneyGPX() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const gpx = journeyToGpx(journey);
      downloadBlob(gpx, "application/gpx+xml", "journey.gpx");
      updateStatusDisplay("GPX downloaded!", "ok");
    }

    function journeyToCsv(journey, sep=',') {
      if (!journey?.length) return '';
      const header = ['latitude','longitude','accuracy','timestamp','speed','heading'].join(sep);
      const rows = journey.map(j =>
        [j.latitude, j.longitude, j.accuracy, isoTime(j.timestamp) || '', j.speed ?? '', j.heading ?? ''].join(sep)
      );
      return header + '\n' + rows.join('\n');
    }
    function downloadJourneyCSV() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const csv = journeyToCsv(journey, ',');
      downloadBlob(csv, "text/csv", "journey.csv");
      updateStatusDisplay("CSV downloaded!", "ok");
    }
    function downloadJourneyTSV() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const tsv = journeyToCsv(journey, '\t');
      downloadBlob(tsv, "text/tab-separated-values", "journey.tsv");
      updateStatusDisplay("TSV downloaded!", "ok");
    }
    function downloadJourneyTXT() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const txt = journey.map(j => `${j.latitude},${j.longitude}`).join('\n');
      downloadBlob(txt, "text/plain", "journey.txt");
      updateStatusDisplay("Plain text downloaded!", "ok");
    }

    function journeyToGeoJson(journey) {
      if (!journey?.length) return '';
      const features = journey.map(j => ({
        type: "Feature",
        geometry: { type: "Point", coordinates: [j.longitude, j.latitude] },
        properties: {
          accuracy: j.accuracy,
          timestamp: isoTime(j.timestamp),
          speed: j.speed,
          heading: j.heading
        }
      }));
      const line = {
        type: "Feature",
        geometry: { type: "LineString", coordinates: journey.map(j => [j.longitude, j.latitude]) },
        properties: {}
      };
      return JSON.stringify({ type: "FeatureCollection", features: [line, ...features] }, null, 2);
    }
    function downloadJourneyGeoJSON() {
      if (!journey.length) { updateStatusDisplay("No journey to export.", "warn"); return; }
      const geojson = journeyToGeoJson(journey);
      downloadBlob(geojson, "application/geo+json", "journey.geojson");
      updateStatusDisplay("GeoJSON downloaded!", "ok");
    }

    function startJourney() {
      if (!navigator.geolocation) { updateStatusDisplay("Geolocation not supported!", "err"); return; }
      started = true; paused = false; saveToStorage();
      clearPins(); createClusterGroup();
      document.getElementById('startBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      setDownloadEnabled(false);
      document.getElementById('resetBtn').disabled = false;
      document.getElementById('accuracyInput').disabled = false;
      if (!startTime) startTime = Date.now();
      updateStatsDisplay(); updateStatusDisplay("Recording...", "ok");
      timerInterval = setInterval(updateStatsDisplay, 1000);

      watchId = navigator.geolocation.watchPosition(
        pos => {
          if (paused) return;
          const { latitude, longitude, accuracy, speed, heading } = pos.coords;
          const timestamp = pos.timestamp;
          if (accuracy <= minAccuracy) {
            let lat = latitude, lng = longitude;
            if (journey.length >= 2) {
              lat = (journey[journey.length-1].latitude + journey[journey.length-2].latitude + latitude) / 3;
              lng = (journey[journey.length-1].longitude + journey[journey.length-2].longitude + longitude) / 3;
            }
            journey.push({
              latitude: lat,
              longitude: lng,
              accuracy,
              timestamp,
              speed: (speed !== undefined) ? speed : null,
              heading: (heading !== undefined) ? heading : null
            });
            accuracyList.push(accuracy);
            saveToStorage();
            const infoHTML = `
              <b>Lat:</b> ${lat.toFixed(5)}<br>
              <b>Lng:</b> ${lng.toFixed(5)}<br>
              <b>Accuracy:</b> ${accuracy} m<br>
              <b>Speed:</b> ${speed!==undefined && speed!==null ? (speed*3.6).toFixed(1)+' km/h':'N/A'}<br>
              <b>Heading:</b> ${heading!==undefined && heading!==null ? heading.toFixed(1)+'¬∞':'N/A'}<br>
              <b>Time:</b> ${formatDate(timestamp)}
            `;
            addPinToCluster(lat, lng, infoHTML, accuracy);
            updateLivePath();
            updateStatsDisplay();
            updateStatusDisplay(`Pin: (${lat.toFixed(5)}, ${lng.toFixed(5)}) | Acc: ${accuracy}m`, "ok");
            updateChart(accuracy);
          } else {
            updateStatusDisplay(`Ignored inaccurate (${accuracy}m > ${minAccuracy}m)`, "warn");
            updateChart(accuracy);
          }
        },
        err => { updateStatusDisplay("Location error: " + err.message, "err"); },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 1500
        }
      );
    }
    function pauseJourney() {
      paused = true;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = false;
      updateStatusDisplay("Paused.", "warn");
      saveToStorage();
    }
    function resumeJourney() {
      paused = false;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      updateStatusDisplay("Resumed recording.", "ok");
      saveToStorage();
    }
    function stopJourney(save=true) {
      if (watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
      started = false; paused = false;
      if (save) saveToStorage();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      setDownloadEnabled(journey.length !== 0);
      document.getElementById('accuracyInput').disabled = false;
      updateStatusDisplay("Stopped. Path drawn.", "ok");
      clearPins();
      const points = journey.map(j => [j.latitude, j.longitude]);
      drawPath(points, true);
      updateStatsDisplay();
      if (timerInterval) clearInterval(timerInterval);
    }
    function resetAll() {
      if (watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
      started = false; paused = false; journey = [];
      clearPins();
      if (path) { map.removeLayer(path); path=null; }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      setDownloadEnabled(false);
      document.getElementById('resetBtn').disabled = true;
      document.getElementById('accuracyInput').disabled = false;
      startTime = null; accuracyList = [];
      if (chart) { chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update(); }
      updateStatsDisplay();
      updateStatusDisplay("Reset.", "warn");
      if (timerInterval) clearInterval(timerInterval);
      clearStorage();
    }

    function restorePins() {
      clearPins(); createClusterGroup();
      journey.forEach(j => {
        const infoHTML = `
          <b>Lat:</b> ${j.latitude.toFixed(5)}<br>
          <b>Lng:</b> ${j.longitude.toFixed(5)}<br>
          <b>Accuracy:</b> ${j.accuracy} m<br>
          <b>Speed:</b> ${j.speed!==undefined && j.speed!==null ? (j.speed*3.6).toFixed(1)+' km/h':'N/A'}<br>
          <b>Heading:</b> ${j.heading!==undefined && j.heading!==null ? j.heading.toFixed(1)+'¬∞':'N/A'}<br>
          <b>Time:</b> ${formatDate(j.timestamp)}
        `;
        addPinToCluster(j.latitude, j.longitude, infoHTML, j.accuracy);
      });
      updateLivePath();
      if (journey.length) map.panTo([journey[journey.length-1].latitude, journey[journey.length-1].longitude], { animate: true });
    }
    function restorePath() {
      clearPins();
      if (journey.length) {
        drawPath(journey.map(j => [j.latitude, j.longitude]), false);
        map.panTo([journey[journey.length-1].latitude, journey[journey.length-1].longitude], { animate: true });
      }
    }
    function restoreChart() {
      if (!chart) return;
      chart.data.labels = Array(accuracyList.length).fill('');
      chart.data.datasets[0].data = accuracyList.slice();
      chart.update('none');
    }

    document.getElementById('toggleGraph').addEventListener('click', function() {
      graphVisible = !graphVisible;
      document.getElementById('chart-container').style.display = graphVisible ? 'block' : 'none';
      this.setAttribute('aria-pressed', graphVisible ? 'true' : 'false');
      this.textContent = graphVisible ? 'üìä' : 'üó∫Ô∏è';
      this.title = graphVisible ? "Hide accuracy graph" : "Show accuracy graph";
      setTimeout(() => { if (map) map.invalidateSize(); }, 150);
    });

    document.getElementById('startBtn').addEventListener('click', function(){ startJourney(); saveToStorage(); });
    document.getElementById('pauseBtn').addEventListener('click', function(){ pauseJourney(); });
    document.getElementById('resumeBtn').addEventListener('click', function(){ resumeJourney(); });
    document.getElementById('stopBtn').addEventListener('click', function(){ stopJourney(true); saveToStorage(); });

    downloadBtnEl().addEventListener('click', function(){ toggleDownloadMenu(); });
    document.getElementById('downloadJson').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyJSON(); });
    document.getElementById('downloadKml').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyKML(); });
    document.getElementById('downloadKmlPath').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyKMLPathOnly(); });
    document.getElementById('downloadGpx').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyGPX(); });
    document.getElementById('downloadCsv').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyCSV(); });
    document.getElementById('downloadTsv').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyTSV(); });
    document.getElementById('downloadTxt').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyTXT(); });
    document.getElementById('downloadGeoJson').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyGeoJSON(); });

    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('accuracyInput').addEventListener('change', function(e){
      minAccuracy = Number(e.target.value);
      saveToStorage();
      updateStatusDisplay('Min accuracy set to ' + minAccuracy + ' meters', "ok");
    });

    window.onload = function() {
      setupChart();
      let d = loadFromStorage();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude } = pos.coords;
            initMap(latitude, longitude, 16);
            if (d && d.journey && d.journey.length) {
              journey = d.journey; startTime = d.startTime;
              started = !!d.started; paused = !!d.paused;
              minAccuracy = d.minAccuracy || 15;
              accuracyList = d.accuracyList || [];
              document.getElementById('accuracyInput').value = minAccuracy;
              restoreChart();
              updateStatsDisplay();
              if (started) {
                restorePins();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = !paused;
                document.getElementById('resumeBtn').disabled = paused ? false : true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                setDownloadEnabled(false);
                document.getElementById('accuracyInput').disabled = false;
                updateStatusDisplay(paused ? "Paused" : "Resumed recording.", paused ? "warn" : "ok");
                timerInterval = setInterval(updateStatsDisplay, 1000);
                if (!paused) startJourney();
              } else {
                restorePath();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('resetBtn').disabled = false;
                setDownloadEnabled(journey.length !== 0);
                document.getElementById('accuracyInput').disabled = false;
                updateStatusDisplay("Journey loaded. Path restored.", "ok");
              }
            } else {
              document.getElementById('resetBtn').disabled = true;
              setDownloadEnabled(false);
              document.getElementById('accuracyInput').disabled = false;
              updateStatusDisplay("Ready.", "ok");
            }
          },
          () => { initMap(); }
        );
      } else { initMap(); }
    };
  </script>
</body>
</html>
