<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPS Journey Recorder - Mobile Enhanced</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <style>
    :root {
      --main-bg: #f2f6fa;
      --accent: #2176ae;
      --accent-dark: #195c83;
      --danger: #e53935;
      --button-radius: 8px;
      --control-padding: 12px;
    }
    body {
      margin: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--main-bg);
      color: #222;
    }
    #controls {
      position: sticky;
      top: 0;
      background: #fff;
      padding: var(--control-padding) 0 var(--control-padding) 0;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
      border-bottom: 1px solid #e0e7ef;
    }
    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .control-group.status-group {
      flex: 1 1 200px;
      min-width: 180px;
      justify-content: flex-start;
    }
    button, input[type=number] {
      font-size: 1.05em;
      border-radius: var(--button-radius);
      border: none;
      padding: 0.5em 1em;
      min-width: 44px;
      min-height: 44px;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 2px rgba(33,118,174,.06);
      transition: background .2s;
      outline: none;
    }
    button:active {
      background: var(--accent-dark);
    }
    button:disabled {
      background: #bbb;
      color: #eee;
      cursor: not-allowed;
    }
    #toggleGraph {
      background: #fff;
      color: var(--accent);
      border: 2px solid var(--accent);
      min-width: 40px;
      min-height: 40px;
      font-size: 1.4em;
      padding: 0.2em 0.6em;
      margin-left: 6px;
      border-radius: 50%;
      vertical-align: middle;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    #toggleGraph:active {
      background: var(--main-bg);
      color: var(--accent-dark);
    }
    label {
      font-size: 1em;
      margin-right: 6px;
      color: var(--accent-dark);
    }
    #accuracyInput {
      color: var(--accent-dark);
      background: #e8f2fa;
      border: 1px solid #b0cde0;
      padding: 0.4em 0.8em;
      margin-right: 6px;
      width: 60px;
      font-size: 1em;
      border-radius: var(--button-radius);
    }
    #chart-container {
      background: #fff;
      border-radius: 10px;
      padding: 8px 8px 0 8px;
      margin: 0 0 8px 0;
      box-shadow: 0 2px 8px rgba(33,118,174,.04);
      width: 96vw;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
    #chart {
      width: 100%;
      height: 120px;
      max-height: 160px;
      display: block;
    }
    #map {
      width: 100vw;
      height: 60vh;
      min-height: 260px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 16px rgba(33,118,174,.07);
      margin-bottom: 0;
      background: #ddd;
      display: block;
    }
    #stats, #status {
      font-size: 1em;
      padding: 2px 8px;
      color: #333;
      background: #e8f2fa;
      border-radius: 6px;
      margin: 0 6px 0 0;
      min-width: 80px;
      text-align: left;
      display: inline-block;
    }
    #status {
      color: #e53935;
      background: #fff3f3;
      border: 1px solid #f9c6c6;
    }
    @media (max-width:700px) {
      #controls {
        flex-direction: column;
        gap: 10px;
        padding: 10px 0;
      }
      .control-group {
        width: 100%;
        justify-content: flex-start;
      }
      #chart-container {
        width: 98vw;
        max-width: 100vw;
      }
      #map {
        height: 54vh;
        min-height: 200px;
      }
      #stats, #status {
        font-size: .96em;
        min-width: 60px;
      }
    }
    @media (max-width:480px) {
      #controls { padding: 7px 0; }
      button, input[type=number] {
        font-size: .95em;
        min-width: 32px;
        min-height: 38px;
        padding: 0.3em 0.7em;
      }
      #chart-container { padding: 2px 2px 0 2px; }
      #chart { height: 80px; }
      #map { min-height: 130px; height: 38vh; }
    }

    /* Download menu */
    .dropdown { position: relative; display: inline-block; }
    .menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #fff;
      border: 1px solid #e0e7ef;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      border-radius: 8px;
      padding: 6px;
      display: none;
      min-width: 180px;
      z-index: 1100;
    }
    .menu.open { display: block; }
    .menu .item {
      width: 100%;
      background: transparent;
      color: #222;
      text-align: left;
      padding: 10px 12px;
      border-radius: 6px;
      border: none;
      min-height: auto;
      min-width: auto;
      box-shadow: none;
      font-size: 1em;
    }
    .menu .item:hover { background: #f2f6fa; }
  </style>
</head>
<body>
  <div id="controls">
    <div class="control-group">
      <button id="startBtn" title="Start recording">Start</button>
      <button id="pauseBtn" disabled title="Pause recording">Pause</button>
      <button id="resumeBtn" disabled title="Resume recording">Resume</button>
      <button id="stopBtn" disabled title="Stop and show path">Stop</button>

      <div class="dropdown">
        <button id="downloadBtn" disabled title="Download">Download â–¾</button>
        <div id="downloadMenu" class="menu" role="menu" aria-hidden="true">
          <button id="downloadJson" class="item" role="menuitem">JSON</button>
          <button id="downloadKml" class="item" role="menuitem">KML (Google Earth)</button>
        </div>
      </div>

      <button id="resetBtn" disabled title="Reset journey">Reset</button>
    </div>
    <div class="control-group">
      <label id="accuracyLabel" for="accuracyInput">Min Acc (m):</label>
      <input type="number" id="accuracyInput" value="15" min="5" max="50" step="1">
      <button id="toggleGraph" title="Show/hide accuracy graph">&#128202;</button>
    </div>
    <div class="control-group status-group">
      <div id="stats"></div>
      <div id="status"></div>
    </div>
  </div>
  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>
  <div id="map"></div>
  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- Utility ---
    function haversine(lat1, lon1, lat2, lon2) {
      function toRad(x) { return x * Math.PI / 180; }
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    function formatTime(ms) {
      let s = Math.floor(ms / 1000);
      let h = Math.floor(s / 3600);
      let m = Math.floor((s % 3600) / 60);
      s = s % 60;
      return `${h>0?h+':':''}${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
    }
    function formatDate(ts) {
      if (ts === undefined || ts === null || Number.isNaN(ts)) return '';
      const d = new Date(ts);
      return isNaN(d.getTime()) ? '' : d.toLocaleTimeString();
    }
    function isoTime(ts) {
      if (ts === undefined || ts === null || Number.isNaN(ts)) return '';
      const d = new Date(ts);
      return isNaN(d.getTime()) ? '' : d.toISOString();
    }
    function saveToStorage() {
      localStorage.setItem('journey_gps', JSON.stringify({
        journey, started, paused, startTime, minAccuracy, accuracyList
      }));
    }
    function loadFromStorage() {
      const d = localStorage.getItem('journey_gps');
      if (!d) return null;
      try { return JSON.parse(d); } catch (e) { return null; }
    }
    function clearStorage() { localStorage.removeItem('journey_gps'); }

    // --- Variables ---
    let map, path;
    let watchId = null;
    let journey = [];
    let markerCluster = null;
    let started = false;
    let paused = false;
    let startTime = null;
    let timerInterval = null;
    let minAccuracy = 15;
    let accuracyList = [];
    let chart = null;
    let graphVisible = true;

    // --- Chart.js Accuracy Graph ---
    function setupChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{
          label: 'Accuracy (m)', data: [], borderColor: '#2176ae', backgroundColor: 'rgba(33,118,174,0.1)', tension: 0.2, pointRadius: 0,
        }]},
        options: {
          scales: { x: {display:false}, y: {beginAtZero:true, title:{display:true,text:'Meters'}} },
          plugins: { legend: {display:false} }
        }
      });
    }
    function updateChart(acc) {
      if (!chart) return;
      chart.data.labels.push('');
      chart.data.datasets[0].data.push(acc);
      if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    // --- Map Setup ---
    function initMap(lat = 51.505, lng = -0.09, zoom = 13) {
      map = L.map('map').setView([lat, lng], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    }
    function createClusterGroup() {
      if (markerCluster) { markerCluster.clearLayers(); map.removeLayer(markerCluster); }
      markerCluster = L.markerClusterGroup();
      map.addLayer(markerCluster);
    }
    function pinColor(accuracy) {
      if (accuracy < 8) return 'green';
      if (accuracy < 15) return 'yellow';
      if (accuracy < 25) return 'orange';
      return 'red';
    }
    function addPinToCluster(lat, lng, infoHTML, accuracy) {
      const marker = L.circleMarker([lat, lng], {
        radius: 8, color: pinColor(accuracy), fillColor: pinColor(accuracy), fillOpacity: .85, weight: 2
      });
      marker.bindPopup(infoHTML);
      markerCluster.addLayer(marker);
    }
    function clearPins() {
      if (markerCluster) { markerCluster.clearLayers(); map.removeLayer(markerCluster); markerCluster = null; }
    }
    function drawPath(points, animate=false) {
      if (path) map.removeLayer(path);
      path = L.polyline([], { color:'#2176ae', weight:5 }).addTo(map);
      if (animate && points.length > 1) {
        let i=0;
        function addNext() {
          if (i < points.length) { path.addLatLng(points[i]); i++; setTimeout(addNext, 40); }
          else { map.fitBounds(path.getBounds()); }
        }
        addNext();
      } else { path.setLatLngs(points); if(points.length) map.fitBounds(path.getBounds()); }
    }
    function updateLivePath() {
      const points = journey.map(j => [j.latitude, j.longitude]);
      if (path) map.removeLayer(path);
      path = L.polyline(points, { color:'#2176ae', weight:5 }).addTo(map);
      if (points.length) map.panTo(points[points.length-1]);
    }

    // --- Stats ---
    function updateStatsDisplay() {
      if (!journey.length) { document.getElementById('stats').textContent = ''; return; }
      let dist = 0;
      for (let i=1; i<journey.length; i++) {
        dist += haversine(journey[i-1].latitude, journey[i-1].longitude, journey[i].latitude, journey[i].longitude);
      }
      dist = Math.round(dist);
      let elapsed = startTime ? Date.now() - startTime : 0;
      let speed = journey.length > 1 && journey[journey.length-1].speed !== null
        ? (journey[journey.length-1].speed*3.6).toFixed(1) + ' km/h' : '-';
      let avgAcc = (journey.reduce((a,j)=>a+j.accuracy,0)/journey.length).toFixed(1);
      document.getElementById('stats').innerHTML =
        `Distance: <b>${dist} m</b> | Time: <b>${formatTime(elapsed)}</b> | Speed: <b>${speed}</b> | Avg Acc: <b>${avgAcc} m</b>`;
    }
    function updateStatusDisplay(text) { document.getElementById('status')..textContent = text; }

    // --- Download menu helpers ---
    const downloadBtn = () => document.getElementById('downloadBtn');
    const downloadMenu = () => document.getElementById('downloadMenu');
    function setDownloadEnabled(enabled) {
      downloadBtn().disabled = !enabled;
      if (!enabled) closeDownloadMenu();
    }
    function toggleDownloadMenu() {
      if (downloadBtn().disabled) return;
      const menu = downloadMenu();
      const isOpen = menu.classList.contains('open');
      menu.classList.toggle('open', !isOpen);
      menu.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
    }
    function closeDownloadMenu() {
      const menu = downloadMenu();
      menu.classList.remove('open');
      menu.setAttribute('aria-hidden', 'true');
    }
    document.addEventListener('click', (e) => {
      const dd = downloadBtn().parentElement;
      if (!dd.contains(e.target)) closeDownloadMenu();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDownloadMenu();
    });

    // --- KML Export ---
    function journeyToKml(journey) {
      if (!journey || journey.length === 0) return '';
      // KML color is aabbggrr; '#2176ae' -> ff ae 76 21
      const pathColor = 'ffae7621';
      const coordsLine = journey.map(j => `${j.longitude.toFixed(6)},${j.latitude.toFixed(6)},0`).join('\n');

      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
      kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n`;
      kml += `  <Document>\n`;
      kml += `    <name>GPS Journey</name>\n`;
      kml += `    <Style id="pathStyle"><LineStyle><color>${pathColor}</color><width>4</width></LineStyle></Style>\n`;
      kml += `    <Placemark>\n`;
      kml += `      <name>Path</name>\n`;
      kml += `      <styleUrl>#pathStyle</styleUrl>\n`;
      kml += `      <LineString>\n`;
      kml += `        <tessellate>1</tessellate>\n`;
      kml += `        <coordinates>\n${coordsLine}\n        </coordinates>\n`;
      kml += `      </LineString>\n`;
      kml += `    </Placemark>\n`;

      // Points with details
      kml += `    <Folder>\n`;
      kml += `      <name>Points</name>\n`;
      journey.forEach((j, idx) => {
        const desc = [
          `Lat: ${j.latitude.toFixed(6)}`,
          `Lng: ${j.longitude.toFixed(6)}`,
          `Accuracy: ${j.accuracy} m`,
          `Speed: ${j.speed !== undefined && j.speed !== null ? (j.speed*3.6).toFixed(1) + ' km/h' : 'N/A'}`,
          `Heading: ${j.heading !== undefined && j.heading !== null ? j.heading.toFixed(1) + 'Â°' : 'N/A'}`
        ].join(' | ');
        const when = isoTime(j.timestamp);
        kml += `      <Placemark>\n`;
        kml += `        <name>Point ${idx+1}</name>\n`;
        if (when) kml += `        <TimeStamp><when>${when}</when></TimeStamp>\n`;
        kml += `        <description><![CDATA[${desc}]]></description>\n`;
        kml += `        <Point><coordinates>${j.longitude.toFixed(6)},${j.latitude.toFixed(6)},0</coordinates></Point>\n`;
        kml += `      </Placemark>\n`;
      });
      kml += `    </Folder>\n`;

      // Start and end markers
      const first = journey[0];
      const last = journey[journey.length - 1];
      const firstWhen = isoTime(first.timestamp);
      const lastWhen = isoTime(last.timestamp);
      kml += `    <Placemark><name>Start</name>${firstWhen?`<TimeStamp><when>${firstWhen}</when></TimeStamp>`:''}<Point><coordinates>${first.longitude.toFixed(6)},${first.latitude.toFixed(6)},0</coordinates></Point></Placemark>\n`;
      kml += `    <Placemark><name>End</name>${lastWhen?`<TimeStamp><when>${lastWhen}</when></TimeStamp>`:''}<Point><coordinates>${last.longitude.toFixed(6)},${last.latitude.toFixed(6)},0</coordinates></Point></Placemark>\n`;

      kml += `  </Document>\n`;
      kml += `</kml>\n`;
      return kml;
    }

    function downloadJourneyKML() {
      if (!journey.length) { updateStatusDisplay("No journey to export."); return; }
      const kml = journeyToKml(journey);
      const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "journey.kml";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      updateStatusDisplay("KML downloaded!");
    }

    function downloadJourneyJSON() {
      // Same as the original: only the points array
      const blob = new Blob([JSON.stringify(journey,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "journey.json";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      updateStatusDisplay("Journey JSON downloaded!");
    }

    // --- Recording ---
    function startJourney() {
      if (!navigator.geolocation) { updateStatusDisplay("Geolocation not supported!"); return; }
      started = true; paused = false; saveToStorage();
      clearPins(); createClusterGroup();
      document.getElementById('startBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      setDownloadEnabled(false);
      document.getElementById('resetBtn').disabled = false;
      document.getElementById('accuracyInput').disabled = false;
      if (!startTime) startTime = Date.now();
      updateStatsDisplay(); updateStatusDisplay("Recording...");
      timerInterval = setInterval(updateStatsDisplay, 1000);

      watchId = navigator.geolocation.watchPosition(
        pos => {
          if (paused) return;
          const { latitude, longitude, accuracy, speed, heading } = pos.coords;
          const timestamp = pos.timestamp; // important: timestamp is on Position, not coords
          if (accuracy <= minAccuracy) {
            // Smoothing: moving average with last 2 points (if available)
            let lat = latitude, lng = longitude;
            if (journey.length >= 2) {
              lat = (journey[journey.length-1].latitude + journey[journey.length-2].latitude + latitude)/3;
              lng = (journey[journey.length-1].longitude + journey[journey.length-2].longitude + longitude)/3;
            }
            journey.push({
              latitude: lat, longitude: lng, accuracy,
              timestamp,
              speed: speed!==undefined?speed:null,
              heading: heading!==undefined?heading:null
            });
            accuracyList.push(accuracy);
            saveToStorage();
            const infoHTML = `
              <b>Lat:</b> ${lat.toFixed(5)}<br>
              <b>Lng:</b> ${lng.toFixed(5)}<br>
              <b>Accuracy:</b> ${accuracy} m<br>
              <b>Speed:</b> ${speed!==undefined && speed!==null ? (speed*3.6).toFixed(1)+' km/h':'N/A'}<br>
              <b>Heading:</b> ${heading!==undefined && heading!==null ? heading.toFixed(1)+'Â°':'N/A'}<br>
              <b>Time:</b> ${formatDate(timestamp)}
            `;
            addPinToCluster(lat, lng, infoHTML, accuracy);
            updateLivePath();
            updateStatsDisplay();
            updateStatusDisplay(`Pin: (${lat.toFixed(5)}, ${lng.toFixed(5)}) | Acc: ${accuracy}m`);
            updateChart(accuracy);
          } else {
            updateStatusDisplay(`Ignored inaccurate (${accuracy}m > ${minAccuracy}m)`);
            updateChart(accuracy);
          }
        },
        err => { updateStatusDisplay("Location error: "+err.message); },
        {
          enableHighAccuracy:true,
          maximumAge:0,
          timeout:1000
        }
      );
    }
    function pauseJourney() {
      paused = true;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = false;
      updateStatusDisplay("Paused.");
      saveToStorage();
    }
    function resumeJourney() {
      paused = false;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      updateStatusDisplay("Resumed recording.");
      saveToStorage();
    }
    function stopJourney(save=true) {
      if (watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
      started = false; paused = false;
      if (save) saveToStorage();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      setDownloadEnabled(journey.length !== 0);
      document.getElementById('accuracyInput').disabled = false;
      updateStatusDisplay("Stopped. Path drawn.");
      clearPins();
      const points = journey.map(j => [j.latitude, j.longitude]);
      drawPath(points, true);
      updateStatsDisplay();
      if (timerInterval) clearInterval(timerInterval);
    }
    function resetAll() {
      if (watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
      started = false; paused = false; journey = [];
      clearPins();
      if (path) { map.removeLayer(path); path=null; }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      setDownloadEnabled(false);
      document.getElementById('resetBtn').disabled = true;
      document.getElementById('accuracyInput').disabled = false;
      startTime = null; accuracyList = [];
      if (chart) { chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update(); }
      updateStatsDisplay();
      updateStatusDisplay("Reset.");
      if (timerInterval) clearInterval(timerInterval);
      clearStorage();
    }

    // --- Restore ---
    function restorePins() {
      clearPins(); createClusterGroup();
      journey.forEach(j => {
        const infoHTML = `
          <b>Lat:</b> ${j.latitude.toFixed(5)}<br>
          <b>Lng:</b> ${j.longitude.toFixed(5)}<br>
          <b>Accuracy:</b> ${j.accuracy} m<br>
          <b>Speed:</b> ${j.speed!==undefined && j.speed!==null ? (j.speed*3.6).toFixed(1)+' km/h':'N/A'}<br>
          <b>Heading:</b> ${j.heading!==undefined && j.heading!==null ? j.heading.toFixed(1)+'Â°':'N/A'}<br>
          <b>Time:</b> ${formatDate(j.timestamp)}
        `;
        addPinToCluster(j.latitude, j.longitude, infoHTML, j.accuracy);
      });
      updateLivePath();
      if (journey.length) map.panTo([journey[journey.length-1].latitude, journey[journey.length-1].longitude]);
    }
    function restorePath() {
      clearPins();
      if (journey.length) {
        drawPath(journey.map(j=>[j.latitude,j.longitude]),false);
        map.panTo([journey[journey.length-1].latitude, journey[journey.length-1].longitude]);
      }
    }
    function restoreChart() {
      if (!chart) return;
      chart.data.labels = Array(accuracyList.length).fill('');
      chart.data.datasets[0].data = accuracyList.slice();
      chart.update();
    }

    // --- Show/Hide Graph ---
    document.getElementById('toggleGraph').addEventListener('click', function() {
      graphVisible = !graphVisible;
      document.getElementById('chart-container').style.display = graphVisible ? 'block' : 'none';
      this.textContent = graphVisible ? 'ðŸ“Š' : 'ðŸ—ºï¸';
      this.title = graphVisible ? "Hide accuracy graph" : "Show accuracy graph";
    });

    // --- Event Listeners ---
    document.getElementById('startBtn').addEventListener('click', function(){ startJourney(); saveToStorage();});
    document.getElementById('pauseBtn').addEventListener('click', function(){ pauseJourney();});
    document.getElementById('resumeBtn').addEventListener('click', function(){ resumeJourney();});
    document.getElementById('stopBtn').addEventListener('click', function(){ stopJourney(true); saveToStorage();});

    downloadBtn().addEventListener('click', function(){ toggleDownloadMenu(); });
    document.getElementById('downloadJson').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyJSON(); });
    document.getElementById('downloadKml').addEventListener('click', function(){ closeDownloadMenu(); downloadJourneyKML(); });

    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('accuracyInput').addEventListener('change', function(e){
      minAccuracy = Number(e.target.value);
      saveToStorage();
      updateStatusDisplay('Min accuracy set to '+minAccuracy+' meters');
    });

    // --- On Load ---
    window.onload = function() {
      setupChart();
      let d = loadFromStorage();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const {latitude,longitude} = pos.coords;
            initMap(latitude,longitude,16);
            if (d && d.journey && d.journey.length) {
              journey = d.journey; startTime = d.startTime;
              started = !!d.started; paused = !!d.paused;
              minAccuracy = d.minAccuracy || 15;
              accuracyList = d.accuracyList || [];
              document.getElementById('accuracyInput').value = minAccuracy;
              restoreChart();
              updateStatsDisplay();
              if (started) {
                restorePins();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = !paused;
                document.getElementById('resumeBtn').disabled = paused?false:true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                setDownloadEnabled(false);
                document.getElementById('accuracyInput').disabled = false;
                updateStatusDisplay(paused?"Paused":"Resumed recording.");
                timerInterval = setInterval(updateStatsDisplay,1000);
                if (!paused) startJourney();
              } else {
                restorePath();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('resetBtn').disabled = false;
                setDownloadEnabled(journey.length !== 0);
                document.getElementById('accuracyInput').disabled = false;
                updateStatusDisplay("Journey loaded. Path restored.");
              }
            } else {
              document.getElementById('resetBtn').disabled = true;
              setDownloadEnabled(false);
              document.getElementById('accuracyInput').disabled = false;
              updateStatusDisplay("Ready.");
            }
          },
          () => { initMap(); }
        );
      } else { initMap(); }
    };
  </script>
</body>
</html>
